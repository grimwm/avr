#!/usr/bin/env python

import sys
import argparse
import os
from subprocess import check_call

def setup_target_arduino_parser(parser):
    parser.set_defaults(target_platform="arduino")

def setup_target_default_parser(parser):
    parser.set_defaults(target_platform="default")

def build_cmake_command(args, this_path):
    cmake_cmd = ["cmake"]
    if args.cmake_debug:
        cmake_cmd.append("--debug-output")
    
    if "arduino" == args.target_platform:
        cmake_cmd.append(
            "-DCMAKE_TOOLCHAIN_FILE=%s" %\
            os.path.join(this_path, "avr_toolchain.cmake"))
        cmake_cmd.extend(["-G", "Unix Makefiles"])
        cmake_cmd.append("-DAVR_TARGET=arduino")

    cmake_cmd.append(src_path)
    return cmake_cmd

this_path = os.path.dirname(sys.argv[0])
src_path = os.path.join(os.getcwd(), this_path, '..')
build_path = os.path.join(src_path, '..', 'build')

parser = argparse.ArgumentParser()
parser.add_argument("--verbose", "-v", action="store_true")
parser.add_argument("--cmake_debug", action="store_true")

target_parsers = parser.add_subparsers(help="Target platform")
setup_target_arduino_parser(target_parsers.add_parser("arduino"))
setup_target_default_parser(target_parsers.add_parser("default"))

args = parser.parse_args()
if args.verbose:
    print args

if not os.path.exists(build_path):
    os.mkdir(build_path)

cmake_cmd = build_cmake_command(args, this_path)
if args.verbose:
    print "cmake_cmd: %s" % " ".join(cmake_cmd)

os.chdir(build_path)
check_call(cmake_cmd)
